<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>

    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body>

<div class="header">–ß–∞—Ç</div>

<div id="messages" class="messages"></div>

<div style="padding:10px;display:flex;gap:8px;align-items:center">
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1">
    <button onclick="sendText()">‚û§</button>
    <button id="recBtn">üé§</button>
</div>

<script>
    const SERVER = "https://dariy-messenger-clean.onrender.com";
    const socket = io(SERVER);

    const params = new URLSearchParams(location.search);
    const chatId = params.get("chatId");
    const username = localStorage.username;

    socket.emit("user_online", username);
    socket.emit("join_chat", chatId);

    /* ===== –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π ===== */

    socket.on("new_message", msg => addMessage(msg));

    function addMessage(msg) {
      const div = document.createElement("div");
      div.className = "msg " + (msg.user === username ? "me" : "other");

      if (msg.type === "text") {
        div.innerText = msg.user + ": " + msg.text;
      }

      if (msg.type === "image") {
        div.innerHTML = "<img src='" + SERVER + msg.file + "' style='max-width:200px;border-radius:12px'>";
      }

      if (msg.type === "voice") {
        div.innerHTML =
          "<audio controls src='" + SERVER + msg.file + "'></audio>";
      }

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    /* ===== –¢–µ–∫—Å—Ç ===== */

    function sendText() {
      if (!text.value) return;

      socket.emit("send_message", {
        chatId,
        user: username,
        text: text.value,
        type: "text"
      });

      text.value = "";
    }

    /* ===== –ì–û–õ–û–° ===== */

    let mediaRecorder;
    let chunks = [];

    recBtn.onclick = async () => {

      if (!mediaRecorder) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = e => chunks.push(e.data);

        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          chunks = [];

          const form = new FormData();
          form.append("file", blob, "voice.webm");

          const res = await fetch(SERVER + "/upload", { method: "POST", body: form });
          const data = await res.json();

          socket.emit("send_message", {
            chatId,
            user: username,
            file: data.file,
            type: "voice"
          });
        };

        mediaRecorder.start();
        recBtn.innerText = "‚èπ";
      } else {
        mediaRecorder.stop();
        mediaRecorder = null;
        recBtn.innerText = "üé§";
      }
    };
</script>

</body>
</html>
